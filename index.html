<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>STANY MINES PRO | Admin Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <style>
        :root {
            --bg-color: #0a0e17;
            --glass: rgba(15, 22, 39, 0.9);
            --glass-border: rgba(0, 247, 255, 0.2);
            --neon-blue: #00f7ff;
            --neon-pink: #ff00ff;
            --neon-green: #00ff9d;
            --neon-red: #ff0055;
            --neon-yellow: #ffcc00;
            --text: #ffffff;
            --text-muted: #8a9bbd;
            --radius: 16px;
            --font-main: 'Poppins', sans-serif;
            --font-cyber: 'Orbitron', monospace;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background-color: var(--bg-color);
            background-image: 
                radial-gradient(circle at 20% 80%, rgba(0, 247, 255, 0.15), transparent 40%),
                radial-gradient(circle at 80% 20%, rgba(255, 0, 255, 0.1), transparent 40%);
            color: var(--text);
            font-family: var(--font-main);
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Login Page */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }

        .login-box {
            background: rgba(15, 22, 39, 0.95);
            border: 2px solid var(--neon-blue);
            border-radius: 20px;
            padding: 40px;
            width: 100%;
            max-width: 400px;
            backdrop-filter: blur(10px);
            box-shadow: 0 0 30px rgba(0, 247, 255, 0.3);
        }

        .login-title {
            font-family: var(--font-cyber);
            text-align: center;
            margin-bottom: 30px;
            font-size: 1.8rem;
            background: linear-gradient(45deg, var(--neon-blue), var(--neon-pink));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--neon-blue);
            font-family: var(--font-cyber);
            font-size: 0.9rem;
        }

        .input-group input {
            width: 100%;
            padding: 15px;
            background: rgba(0, 0, 0, 0.3);
            border: 2px solid var(--glass-border);
            border-radius: 10px;
            color: white;
            font-size: 1rem;
            transition: all 0.3s;
        }

        .input-group input:focus {
            outline: none;
            border-color: var(--neon-blue);
            box-shadow: 0 0 15px rgba(0, 247, 255, 0.3);
        }

        .login-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, var(--neon-green), #00a86b);
            border: none;
            border-radius: 10px;
            color: #000;
            font-family: var(--font-cyber);
            font-weight: 700;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0, 255, 157, 0.4);
        }

        /* Dashboard Header */
        .dashboard-header {
            background: rgba(15, 22, 39, 0.9);
            border-bottom: 2px solid var(--glass-border);
            padding: 20px;
            margin-bottom: 30px;
            border-radius: 0 0 var(--radius) var(--radius);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            backdrop-filter: blur(10px);
        }

        .header-left h1 {
            font-family: var(--font-cyber);
            font-size: 1.5rem;
            background: linear-gradient(45deg, var(--neon-blue), var(--neon-pink));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        .header-right {
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .logout-btn {
            padding: 10px 20px;
            background: linear-gradient(135deg, var(--neon-red), #cc0044);
            border: none;
            border-radius: 8px;
            color: white;
            font-family: var(--font-cyber);
            cursor: pointer;
            transition: all 0.3s;
        }

        .logout-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 0, 85, 0.4);
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: rgba(15, 22, 39, 0.9);
            border: 2px solid var(--glass-border);
            border-radius: var(--radius);
            padding: 25px;
            text-align: center;
            transition: all 0.3s;
            backdrop-filter: blur(5px);
        }

        .stat-card:hover {
            transform: translateY(-5px);
            border-color: var(--neon-blue);
            box-shadow: 0 10px 30px rgba(0, 247, 255, 0.2);
        }

        .stat-icon {
            font-size: 2.5rem;
            margin-bottom: 15px;
            color: var(--neon-blue);
        }

        .stat-value {
            font-family: var(--font-cyber);
            font-size: 2rem;
            color: var(--neon-green);
            margin-bottom: 10px;
        }

        .stat-label {
            color: var(--text-muted);
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            flex-wrap: wrap;
            background: rgba(15, 22, 39, 0.9);
            padding: 15px;
            border-radius: var(--radius);
            border: 2px solid var(--glass-border);
        }

        .tab-btn {
            padding: 12px 25px;
            background: rgba(0, 0, 0, 0.3);
            border: 2px solid var(--glass-border);
            border-radius: 10px;
            color: var(--text);
            font-family: var(--font-cyber);
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .tab-btn.active {
            background: linear-gradient(135deg, var(--neon-blue), #0066ff);
            border-color: var(--neon-blue);
            color: #000;
            font-weight: 700;
        }

        .tab-btn:hover:not(.active) {
            border-color: var(--neon-blue);
            color: var(--neon-blue);
        }

        /* Tab Content */
        .tab-content {
            display: none;
            animation: fadeIn 0.5s ease;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Tables */
        .data-table {
            width: 100%;
            background: rgba(15, 22, 39, 0.9);
            border: 2px solid var(--glass-border);
            border-radius: var(--radius);
            overflow: hidden;
            backdrop-filter: blur(5px);
            margin-bottom: 30px;
        }

        .table-header {
            background: rgba(0, 0, 0, 0.3);
            padding: 20px;
            border-bottom: 2px solid var(--glass-border);
        }

        .table-title {
            font-family: var(--font-cyber);
            color: var(--neon-blue);
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .table-body {
            max-height: 400px;
            overflow-y: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background: rgba(0, 0, 0, 0.2);
            padding: 15px;
            text-align: left;
            color: var(--neon-blue);
            font-family: var(--font-cyber);
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            border-bottom: 2px solid var(--glass-border);
        }

        td {
            padding: 15px;
            border-bottom: 1px solid var(--glass-border);
        }

        tr:hover {
            background: rgba(0, 247, 255, 0.05);
        }

        .status-badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 700;
            display: inline-block;
        }

        .status-active {
            background: linear-gradient(45deg, var(--neon-green), #00a86b);
            color: #000;
        }

        .status-expired {
            background: linear-gradient(45deg, var(--neon-red), #cc0044);
            color: white;
        }

        .status-free {
            background: linear-gradient(45deg, var(--neon-yellow), orange);
            color: #000;
        }

        .status-premium {
            background: linear-gradient(45deg, var(--neon-blue), #0066ff);
            color: white;
        }

        /* Forms */
        .form-group {
            background: rgba(15, 22, 39, 0.9);
            border: 2px solid var(--glass-border);
            border-radius: var(--radius);
            padding: 25px;
            margin-bottom: 30px;
            backdrop-filter: blur(5px);
        }

        .form-title {
            font-family: var(--font-cyber);
            color: var(--neon-blue);
            margin-bottom: 20px;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-control {
            display: flex;
            flex-direction: column;
        }

        .form-control label {
            margin-bottom: 8px;
            color: var(--neon-blue);
            font-family: var(--font-cyber);
            font-size: 0.9rem;
        }

        .form-control input,
        .form-control select {
            padding: 12px;
            background: rgba(0, 0, 0, 0.3);
            border: 2px solid var(--glass-border);
            border-radius: 8px;
            color: white;
            font-size: 1rem;
            transition: all 0.3s;
        }

        .form-control input:focus,
        .form-control select:focus {
            outline: none;
            border-color: var(--neon-blue);
            box-shadow: 0 0 15px rgba(0, 247, 255, 0.3);
        }

        .generate-btn {
            padding: 15px 30px;
            background: linear-gradient(135deg, var(--neon-green), #00a86b);
            border: none;
            border-radius: 10px;
            color: #000;
            font-family: var(--font-cyber);
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .generate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0, 255, 157, 0.4);
        }

        /* Code Display */
        .codes-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .code-card {
            background: rgba(15, 22, 39, 0.9);
            border: 2px solid var(--glass-border);
            border-radius: var(--radius);
            padding: 20px;
            transition: all 0.3s;
            backdrop-filter: blur(5px);
        }

        .code-card:hover {
            border-color: var(--neon-blue);
            transform: translateY(-5px);
        }

        .code-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .code-value {
            font-family: var(--font-cyber);
            font-size: 1.2rem;
            color: var(--neon-green);
            letter-spacing: 2px;
            background: rgba(0, 0, 0, 0.3);
            padding: 10px;
            border-radius: 8px;
            text-align: center;
            margin: 10px 0;
            cursor: pointer;
            transition: all 0.3s;
        }

        .code-value:hover {
            background: rgba(0, 255, 157, 0.1);
            transform: scale(1.02);
        }

        .code-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            font-size: 0.9rem;
        }

        .detail-item {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px solid var(--glass-border);
        }

        .detail-label {
            color: var(--text-muted);
        }

        .detail-value {
            color: var(--text);
            font-weight: 500;
        }

        /* Loading */
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 200px;
            font-family: var(--font-cyber);
            color: var(--neon-blue);
            font-size: 1.2rem;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid var(--glass-border);
            border-top-color: var(--neon-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 15px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Message Box */
        .message-box {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(15, 22, 39, 0.95);
            border: 2px solid var(--neon-green);
            border-radius: var(--radius);
            padding: 20px;
            max-width: 400px;
            z-index: 1000;
            display: none;
            backdrop-filter: blur(10px);
            box-shadow: 0 5px 30px rgba(0, 0, 0, 0.3);
        }

        .message-box.show {
            display: block;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .message-content {
            color: var(--text);
            margin-bottom: 15px;
        }

        .message-close {
            background: var(--neon-red);
            border: none;
            padding: 8px 15px;
            border-radius: 6px;
            color: white;
            cursor: pointer;
            font-family: var(--font-cyber);
            float: right;
        }

        /* Action Buttons */
        .action-btn {
            padding: 5px 10px;
            border: none;
            border-radius: 5px;
            font-family: var(--font-cyber);
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.3s;
        }

        .action-view {
            background: var(--neon-blue);
            color: #000;
        }

        .action-delete {
            background: var(--neon-red);
            color: white;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .tabs {
                flex-direction: column;
            }
            
            .tab-btn {
                width: 100%;
            }
            
            .table-body {
                max-height: 300px;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .codes-grid {
                grid-template-columns: 1fr;
            }
            
            .header-left h1 {
                font-size: 1.2rem;
            }
        }
    </style>
</head>
<body>
    <!-- Login Page -->
    <div id="loginPage" class="login-container">
        <div class="login-box">
            <h1 class="login-title">STANY MINES PRO<br>ADMIN PANEL</h1>
            <div class="input-group">
                <label><i class="fas fa-user"></i> ADMIN USERNAME</label>
                <input type="text" id="adminUsername" placeholder="Enter admin username">
            </div>
            <div class="input-group">
                <label><i class="fas fa-lock"></i> PASSWORD</label>
                <input type="password" id="adminPassword" placeholder="Enter password">
            </div>
            <button class="login-btn" onclick="loginAdmin()">
                <i class="fas fa-sign-in-alt"></i> LOGIN
            </button>
            <div style="margin-top: 20px; text-align: center; color: var(--text-muted); font-size: 0.8rem;">
                <i class="fas fa-shield-alt"></i> Secure Admin Access
            </div>
        </div>
    </div>

    <!-- Dashboard -->
    <div id="dashboard" style="display: none;">
        <div class="dashboard-header">
            <div class="header-left">
                <h1><i class="fas fa-tachometer-alt"></i> ADMIN DASHBOARD</h1>
                <div style="font-size: 0.8rem; color: var(--text-muted); margin-top: 5px;">
                    Stany Mines Pro Management System
                </div>
            </div>
            <div class="header-right">
                <div style="color: var(--neon-green); font-family: var(--font-cyber);">
                    <i class="fas fa-user-circle"></i> <span id="adminName"></span>
                </div>
                <button class="logout-btn" onclick="logoutAdmin()">
                    <i class="fas fa-sign-out-alt"></i> LOGOUT
                </button>
            </div>
        </div>

        <div class="container">
            <!-- Stats Grid -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon"><i class="fas fa-users"></i></div>
                    <div class="stat-value" id="totalUsers">0</div>
                    <div class="stat-label">Total Users</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon"><i class="fas fa-money-bill-wave"></i></div>
                    <div class="stat-value" id="totalRevenue">0 TZS</div>
                    <div class="stat-label">Total Revenue</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon"><i class="fas fa-key"></i></div>
                    <div class="stat-value" id="activeCodes">0</div>
                    <div class="stat-label">Active Codes</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon"><i class="fas fa-bolt"></i></div>
                    <div class="stat-value" id="todayPredictions">0</div>
                    <div class="stat-label">Today Predictions</div>
                </div>
            </div>

            <!-- Tabs -->
            <div class="tabs">
                <button class="tab-btn active" onclick="showTab('users')">
                    <i class="fas fa-users"></i> Users
                </button>
                <button class="tab-btn" onclick="showTab('codes')">
                    <i class="fas fa-key"></i> Codes
                </button>
                <button class="tab-btn" onclick="showTab('payments')">
                    <i class="fas fa-credit-card"></i> Payments
                </button>
                <button class="tab-btn" onclick="showTab('createCode')">
                    <i class="fas fa-plus-circle"></i> Create Code
                </button>
                <button class="tab-btn" onclick="showTab('resellers')">
                    <i class="fas fa-user-tie"></i> Resellers
                </button>
                <button class="tab-btn" onclick="showTab('settings')">
                    <i class="fas fa-cog"></i> Settings
                </button>
            </div>

            <!-- USERS TAB -->
            <div id="usersTab" class="tab-content active">
                <div class="data-table">
                    <div class="table-header">
                        <div class="table-title">
                            <i class="fas fa-users"></i> ALL USERS
                            <div style="margin-left: auto; font-size: 0.8rem; color: var(--text-muted);">
                                <i class="fas fa-search"></i> 
                                <input type="text" id="userSearch" placeholder="Search users..." style="margin-left: 10px; padding: 5px; background: rgba(0,0,0,0.3); border: 1px solid var(--glass-border); color: white; border-radius: 5px;">
                            </div>
                        </div>
                    </div>
                    <div class="table-body">
                        <div class="loading" id="usersLoading">
                            <div class="loading-spinner"></div>
                            Loading users...
                        </div>
                        <table id="usersTable" style="display: none;">
                            <thead>
                                <tr>
                                    <th>Username</th>
                                    <th>Device ID</th>
                                    <th>Status</th>
                                    <th>Package</th>
                                    <th>Expires</th>
                                    <th>Last Active</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="usersList">
                                <!-- Users will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- CODES TAB -->
            <div id="codesTab" class="tab-content">
                <div class="data-table">
                    <div class="table-header">
                        <div class="table-title">
                            <i class="fas fa-key"></i> ALL CODES
                            <div style="margin-left: auto; display: flex; gap: 10px;">
                                <select id="codeFilter" style="padding: 5px; background: rgba(0,0,0,0.3); border: 1px solid var(--glass-border); color: white; border-radius: 5px;">
                                    <option value="all">All Codes</option>
                                    <option value="active">Active Only</option>
                                    <option value="used">Used Only</option>
                                    <option value="premium">Premium Codes</option>
                                    <option value="reseller">Reseller Codes</option>
                                </select>
                                <button class="action-btn action-view" onclick="filterCodes()">
                                    <i class="fas fa-filter"></i> Filter
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="table-body">
                        <div class="loading" id="codesLoading">
                            <div class="loading-spinner"></div>
                            Loading codes...
                        </div>
                        <table id="codesTable" style="display: none;">
                            <thead>
                                <tr>
                                    <th>Code</th>
                                    <th>Type</th>
                                    <th>Duration</th>
                                    <th>Status</th>
                                    <th>Used By</th>
                                    <th>Created</th>
                                    <th>Expires</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="codesList">
                                <!-- Codes will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- PAYMENTS TAB -->
            <div id="paymentsTab" class="tab-content">
                <div class="data-table">
                    <div class="table-header">
                        <div class="table-title">
                            <i class="fas fa-credit-card"></i> PAYMENT HISTORY
                            <div style="margin-left: auto; font-size: 0.8rem; color: var(--text-muted);">
                                Total: <span id="totalPaymentsCount">0</span> | Amount: <span id="totalPaymentsAmount">0 TZS</span>
                            </div>
                        </div>
                    </div>
                    <div class="table-body">
                        <div class="loading" id="paymentsLoading">
                            <div class="loading-spinner"></div>
                            Loading payments...
                        </div>
                        <table id="paymentsTable" style="display: none;">
                            <thead>
                                <tr>
                                    <th>Order ID</th>
                                    <th>Username</th>
                                    <th>Phone</th>
                                    <th>Amount</th>
                                    <th>Package</th>
                                    <th>Status</th>
                                    <th>Date</th>
                                </tr>
                            </thead>
                            <tbody id="paymentsList">
                                <!-- Payments will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- CREATE CODE TAB -->
            <div id="createCodeTab" class="tab-content">
                <div class="form-group">
                    <div class="form-title">
                        <i class="fas fa-plus-circle"></i> CREATE NEW CODE
                    </div>
                    
                    <div class="form-row">
                        <div class="form-control">
                            <label><i class="fas fa-code"></i> CODE TYPE</label>
                            <select id="codeType" onchange="toggleCodeOptions()">
                                <option value="premium">Premium Code</option>
                                <option value="reseller">Reseller Code</option>
                            </select>
                        </div>
                        
                        <div class="form-control">
                            <label><i class="fas fa-clock"></i> DURATION</label>
                            <select id="codeDuration">
                                <option value="week">1 Week</option>
                                <option value="month">1 Month</option>
                                <option value="lifetime">Lifetime</option>
                                <option value="custom">Custom (Days)</option>
                            </select>
                        </div>
                        
                        <div class="form-control" id="customDaysContainer" style="display: none;">
                            <label><i class="fas fa-calendar-day"></i> CUSTOM DAYS</label>
                            <input type="number" id="customDays" min="1" max="365" placeholder="Enter days">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-control" id="codeLimitContainer" style="display: none;">
                            <label><i class="fas fa-hashtag"></i> MAX CODES FOR RESELLER</label>
                            <input type="number" id="maxCodes" min="1" max="100" value="10" placeholder="Max codes reseller can generate">
                        </div>
                        
                        <div class="form-control">
                            <label><i class="fas fa-sort-numeric-up"></i> QUANTITY</label>
                            <input type="number" id="codeQuantity" min="1" max="50" value="1">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-control">
                            <label><i class="fas fa-microchip"></i> DEVICE LOCK</label>
                            <select id="deviceLock">
                                <option value="true">Yes (One device only)</option>
                                <option value="false">No (Multiple devices)</option>
                            </select>
                        </div>
                        
                        <div class="form-control">
                            <label><i class="fas fa-user"></i> ASSIGN TO USER (Optional)</label>
                            <input type="text" id="assignUser" placeholder="Username to assign code">
                        </div>
                    </div>
                    
                    <button class="generate-btn" onclick="generateCodes()">
                        <i class="fas fa-bolt"></i> GENERATE CODES
                    </button>
                </div>
                
                <div id="generatedCodes" style="display: none;">
                    <div class="form-title">
                        <i class="fas fa-key"></i> GENERATED CODES
                    </div>
                    <div class="codes-grid" id="codeResults">
                        <!-- Generated codes will appear here -->
                    </div>
                </div>
            </div>

            <!-- RESELLERS TAB -->
            <div id="resellersTab" class="tab-content">
                <div class="data-table">
                    <div class="table-header">
                        <div class="table-title">
                            <i class="fas fa-user-tie"></i> RESELLERS MANAGEMENT
                            <button class="action-btn action-view" onclick="refreshResellers()" style="margin-left: auto;">
                                <i class="fas fa-sync-alt"></i> Refresh
                            </button>
                        </div>
                    </div>
                    <div class="table-body">
                        <div class="loading" id="resellersLoading">
                            <div class="loading-spinner"></div>
                            Loading resellers...
                        </div>
                        <table id="resellersTable" style="display: none;">
                            <thead>
                                <tr>
                                    <th>Reseller Code</th>
                                    <th>Username</th>
                                    <th>Max Codes</th>
                                    <th>Used Codes</th>
                                    <th>Expires</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="resellersList">
                                <!-- Resellers will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- SETTINGS TAB -->
            <div id="settingsTab" class="tab-content">
                <div class="form-group">
                    <div class="form-title">
                        <i class="fas fa-cog"></i> SYSTEM SETTINGS
                    </div>
                    
                    <div class="form-row">
                        <div class="form-control">
                            <label><i class="fas fa-gift"></i> FREE TRIALS PER DAY</label>
                            <input type="number" id="freeTrialsPerDay" value="2" min="1" max="10">
                        </div>
                        
                        <div class="form-control">
                            <label><i class="fas fa-clock"></i> FREE TRIAL DURATION (Hours)</label>
                            <input type="number" id="freeTrialHours" value="2" min="1" max="24">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-control">
                            <label><i class="fas fa-money-bill-wave"></i> WEEKLY PRICE (TZS)</label>
                            <input type="number" id="weeklyPrice" value="3000" min="1000" max="10000">
                        </div>
                        
                        <div class="form-control">
                            <label><i class="fas fa-money-bill-wave"></i> MONTHLY PRICE (TZS)</label>
                            <input type="number" id="monthlyPrice" value="4000" min="1000" max="20000">
                        </div>
                        
                        <div class="form-control">
                            <label><i class="fas fa-money-bill-wave"></i> LIFETIME PRICE (TZS)</label>
                            <input type="number" id="lifetimePrice" value="5000" min="1000" max="50000">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-control">
                            <label><i class="fas fa-key"></i> HARAKAPAY API KEY</label>
                            <input type="text" id="harakapayApiKey" value="hpk_fb763cc04e2feec29eb19041f75f54d0e6eb0067486caaae">
                        </div>
                        
                        <div class="form-control">
                            <label><i class="fas fa-phone"></i> WHATSAPP NUMBER</label>
                            <input type="text" id="whatsappNumber" value="255XXXXXXXXX" placeholder="255XXXXXXXXX">
                        </div>
                    </div>
                    
                    <button class="generate-btn" onclick="saveSettings()">
                        <i class="fas fa-save"></i> SAVE SETTINGS
                    </button>
                </div>
                
                <div class="form-group">
                    <div class="form-title">
                        <i class="fas fa-database"></i> DATABASE MANAGEMENT
                    </div>
                    
                    <div class="form-row">
                        <div class="form-control">
                            <label><i class="fas fa-trash"></i> CLEAR EXPIRED DATA</label>
                            <button class="action-btn action-delete" onclick="clearExpiredData()" style="width: 100%; padding: 12px;">
                                <i class="fas fa-trash-alt"></i> Clear Expired Users & Codes
                            </button>
                        </div>
                        
                        <div class="form-control">
                            <label><i class="fas fa-download"></i> EXPORT DATA</label>
                            <button class="action-btn action-view" onclick="exportData()" style="width: 100%; padding: 12px;">
                                <i class="fas fa-file-export"></i> Export All Data (CSV)
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Message Box -->
    <div class="message-box" id="messageBox">
        <div class="message-content" id="messageContent"></div>
        <button class="message-close" onclick="hideMessage()">Close</button>
    </div>

    <script>
        // Firebase Configuration - YOUR CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyDtWAjmGIWVr3QGESAClBzRkQ5AZr5Zeys",
            authDomain: "stanybots.firebaseapp.com",
            projectId: "stanybots",
            storageBucket: "stanybots.firebasestorage.app",
            messagingSenderId: "381983533939",
            appId: "1:381983533939:web:201157399592c6389df306",
            measurementId: "G-W3C0C280BY"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Admin credentials
        const ADMIN_CREDENTIALS = {
            username: "admin",
            password: "StanyMines2026!"
        };

        // HarakaPay API Key
        const HARAKA_API_KEY = "hpk_fb763cc04e2feec29eb19041f75f54d0e6eb0067486caaae";

        let adminLoggedIn = false;
        let statsListener = null;
        let usersListener = null;
        let codesListener = null;
        let paymentsListener = null;
        let resellersListener = null;

        // Initialize App
        document.addEventListener('DOMContentLoaded', function() {
            // Check for saved admin session
            const savedAdmin = localStorage.getItem('stany_admin');
            if (savedAdmin) {
                const adminData = JSON.parse(savedAdmin);
                if (adminData.expiry > Date.now()) {
                    document.getElementById('adminUsername').value = adminData.username;
                    document.getElementById('adminPassword').focus();
                }
            }
            
            // Setup event listeners
            document.getElementById('codeDuration').addEventListener('change', toggleCodeOptions);
            document.getElementById('codeType').addEventListener('change', toggleCodeOptions);
            document.getElementById('userSearch').addEventListener('input', searchUsers);
            
            // Initial toggle
            toggleCodeOptions();
        });

        // Login Function
        function loginAdmin() {
            const username = document.getElementById('adminUsername').value.trim();
            const password = document.getElementById('adminPassword').value;

            if (username === ADMIN_CREDENTIALS.username && password === ADMIN_CREDENTIALS.password) {
                adminLoggedIn = true;
                
                // Save session
                const sessionData = {
                    username: username,
                    expiry: Date.now() + (24 * 60 * 60 * 1000) // 24 hours
                };
                localStorage.setItem('stany_admin', JSON.stringify(sessionData));
                
                document.getElementById('loginPage').style.display = 'none';
                document.getElementById('dashboard').style.display = 'block';
                document.getElementById('adminName').textContent = username;
                
                // Initialize dashboard
                loadStats();
                showTab('users');
                showMessage('Welcome Admin! Dashboard loaded.', 'success');
                
                // Load settings
                loadSettings();
            } else {
                showMessage('Invalid credentials. Please try again.', 'error');
            }
        }

        // Logout Function
        function logoutAdmin() {
            if (confirm('Are you sure you want to logout?')) {
                adminLoggedIn = false;
                
                // Remove all listeners
                if (statsListener) statsListener();
                if (usersListener) usersListener();
                if (codesListener) codesListener();
                if (paymentsListener) paymentsListener();
                if (resellersListener) resellersListener();
                
                document.getElementById('dashboard').style.display = 'none';
                document.getElementById('loginPage').style.display = 'flex';
                document.getElementById('adminUsername').value = '';
                document.getElementById('adminPassword').value = '';
                
                localStorage.removeItem('stany_admin');
                showMessage('Logged out successfully.', 'info');
            }
        }

        // Load Stats
        async function loadStats() {
            try {
                // Get total users
                const usersSnapshot = await db.collection('users').get();
                const totalUsers = usersSnapshot.size;
                document.getElementById('totalUsers').textContent = totalUsers;

                // Get total revenue
                const paymentsSnapshot = await db.collection('payments')
                    .where('status', '==', 'completed')
                    .get();
                
                let totalRevenue = 0;
                paymentsSnapshot.forEach(doc => {
                    totalRevenue += doc.data().amount || 0;
                });
                document.getElementById('totalRevenue').textContent = totalRevenue.toLocaleString() + ' TZS';

                // Get active codes (not used and not expired)
                const now = Date.now();
                const codesSnapshot = await db.collection('codes')
                    .where('used', '==', false)
                    .get();
                
                let activeCodes = 0;
                codesSnapshot.forEach(doc => {
                    const code = doc.data();
                    if (!code.expiry || code.expiry > now) {
                        activeCodes++;
                    }
                });
                document.getElementById('activeCodes').textContent = activeCodes;

                // Get today's predictions
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const predictionsSnapshot = await db.collection('predictions')
                    .where('timestamp', '>=', today)
                    .get();
                document.getElementById('todayPredictions').textContent = predictionsSnapshot.size;

            } catch (error) {
                console.error('Error loading stats:', error);
                showMessage('Error loading statistics', 'error');
            }
        }

        // Tab Navigation
        function showTab(tabName) {
            // Update active tab button
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.currentTarget.classList.add('active');

            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });

            // Show selected tab
            document.getElementById(tabName + 'Tab').classList.add('active');

            // Load data for tab
            switch(tabName) {
                case 'users':
                    loadUsers();
                    break;
                case 'codes':
                    loadCodes();
                    break;
                case 'payments':
                    loadPayments();
                    break;
                case 'resellers':
                    loadResellers();
                    break;
                case 'settings':
                    loadSettings();
                    break;
            }
        }

        // Load Users
        async function loadUsers() {
            const loading = document.getElementById('usersLoading');
            const table = document.getElementById('usersTable');
            
            loading.style.display = 'flex';
            table.style.display = 'none';

            try {
                // Remove previous listener
                if (usersListener) usersListener();
                
                // Set up real-time listener
                usersListener = db.collection('users')
                    .orderBy('lastActive', 'desc')
                    .onSnapshot(snapshot => {
                        const usersList = document.getElementById('usersList');
                        usersList.innerHTML = '';

                        snapshot.forEach(doc => {
                            const user = doc.data();
                            const row = document.createElement('tr');
                            
                            // Format last active
                            const lastActive = user.lastActive?.toDate ? user.lastActive.toDate() : new Date(user.lastActive || Date.now());
                            const timeAgo = getTimeAgo(lastActive);
                            
                            // Status badge
                            let statusBadge = '<span class="status-badge status-free">FREE</span>';
                            if (user.status === 'premium') {
                                statusBadge = '<span class="status-badge status-premium">PREMIUM</span>';
                            } else if (user.status === 'reseller') {
                                statusBadge = '<span class="status-badge" style="background:linear-gradient(45deg, var(--neon-pink), #cc00ff)">RESELLER</span>';
                            } else if (user.status === 'pending') {
                                statusBadge = '<span class="status-badge" style="background:var(--text-muted)">PENDING</span>';
                            }
                            
                            // Expiry display
                            let expiryText = 'N/A';
                            if (user.expiry) {
                                const expiryDate = new Date(user.expiry);
                                if (expiryDate > new Date()) {
                                    expiryText = expiryDate.toLocaleDateString();
                                } else {
                                    expiryText = '<span style="color:var(--neon-red)">EXPIRED</span>';
                                }
                            }
                            
                            // Device ID shortened
                            const shortDeviceId = user.deviceId ? user.deviceId.substring(0, 8) + '...' : 'N/A';
                            
                            row.innerHTML = `
                                <td><strong>${user.username}</strong></td>
                                <td><small title="${user.deviceId || 'N/A'}">${shortDeviceId}</small></td>
                                <td>${statusBadge}</td>
                                <td>${user.package || 'N/A'}</td>
                                <td>${expiryText}</td>
                                <td>${timeAgo}</td>
                                <td>
                                    <button class="action-btn action-view" onclick="viewUser('${user.username}')" title="View Details">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button class="action-btn action-delete" onclick="deleteUser('${user.username}')" title="Delete User">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                            `;
                            
                            usersList.appendChild(row);
                        });

                        loading.style.display = 'none';
                        table.style.display = 'table';
                    });

            } catch (error) {
                console.error('Error loading users:', error);
                showMessage('Error loading users', 'error');
                loading.style.display = 'none';
            }
        }

        // Search Users
        function searchUsers() {
            const searchTerm = document.getElementById('userSearch').value.toLowerCase();
            const rows = document.querySelectorAll('#usersList tr');
            
            rows.forEach(row => {
                const username = row.cells[0].textContent.toLowerCase();
                if (username.includes(searchTerm)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }

        // Load Codes
        async function loadCodes() {
            const loading = document.getElementById('codesLoading');
            const table = document.getElementById('codesTable');
            
            loading.style.display = 'flex';
            table.style.display = 'none';

            try {
                if (codesListener) codesListener();
                
                codesListener = db.collection('codes')
                    .orderBy('createdAt', 'desc')
                    .onSnapshot(snapshot => {
                        const codesList = document.getElementById('codesList');
                        codesList.innerHTML = '';

                        snapshot.forEach(doc => {
                            const code = doc.data();
                            const row = document.createElement('tr');
                            
                            // Determine status
                            const now = Date.now();
                            let status = 'ACTIVE';
                            let statusClass = 'status-active';
                            
                            if (code.used) {
                                status = 'USED';
                                statusClass = 'status-expired';
                            } else if (code.expiry && code.expiry < now) {
                                status = 'EXPIRED';
                                statusClass = 'status-expired';
                            }
                            
                            // Type badge
                            let typeBadge = '<span style="color:var(--neon-blue)">PREMIUM</span>';
                            if (code.type === 'reseller') {
                                typeBadge = '<span style="color:var(--neon-pink)">RESELLER</span>';
                            }
                            
                            // Duration
                            let duration = code.duration || 'N/A';
                            if (code.durationDays) {
                                duration = code.durationDays + ' days';
                            }
                            
                            // Dates
                            let createdDate = 'N/A';
                            if (code.createdAt) {
                                createdDate = code.createdAt.toDate ? 
                                    code.createdAt.toDate().toLocaleDateString() : 
                                    new Date(code.createdAt).toLocaleDateString();
                            }
                            
                            let expiryDate = 'N/A';
                            if (code.expiry) {
                                expiryDate = new Date(code.expiry).toLocaleDateString();
                            }
                            
                            row.innerHTML = `
                                <td><strong>${doc.id}</strong></td>
                                <td>${typeBadge}</td>
                                <td>${duration}</td>
                                <td><span class="status-badge ${statusClass}">${status}</span></td>
                                <td>${code.usedBy || 'Not used'}</td>
                                <td>${createdDate}</td>
                                <td>${expiryDate}</td>
                                <td>
                                    <button class="action-btn action-view" onclick="copyCode('${doc.id}')" title="Copy Code">
                                        <i class="fas fa-copy"></i>
                                    </button>
                                    <button class="action-btn action-delete" onclick="deleteCode('${doc.id}')" title="Delete Code">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                            `;
                            
                            codesList.appendChild(row);
                        });

                        loading.style.display = 'none';
                        table.style.display = 'table';
                    });

            } catch (error) {
                console.error('Error loading codes:', error);
                showMessage('Error loading codes', 'error');
                loading.style.display = 'none';
            }
        }

        // Filter Codes
        function filterCodes() {
            const filterValue = document.getElementById('codeFilter').value;
            const rows = document.querySelectorAll('#codesList tr');
            const now = Date.now();
            
            rows.forEach(row => {
                const type = row.cells[1].textContent.toLowerCase();
                const status = row.cells[3].textContent;
                
                let show = true;
                
                switch(filterValue) {
                    case 'active':
                        show = status.includes('ACTIVE');
                        break;
                    case 'used':
                        show = status.includes('USED');
                        break;
                    case 'premium':
                        show = type.includes('premium');
                        break;
                    case 'reseller':
                        show = type.includes('reseller');
                        break;
                }
                
                row.style.display = show ? '' : 'none';
            });
        }

        // Load Payments
        async function loadPayments() {
            const loading = document.getElementById('paymentsLoading');
            const table = document.getElementById('paymentsTable');
            
            loading.style.display = 'flex';
            table.style.display = 'none';

            try {
                if (paymentsListener) paymentsListener();
                
                paymentsListener = db.collection('payments')
                    .orderBy('timestamp', 'desc')
                    .onSnapshot(snapshot => {
                        const paymentsList = document.getElementById('paymentsList');
                        paymentsList.innerHTML = '';
                        
                        let totalCount = 0;
                        let totalAmount = 0;

                        snapshot.forEach(doc => {
                            totalCount++;
                            const payment = doc.data();
                            const row = document.createElement('tr');
                            
                            // Amount
                            const amount = payment.amount || 0;
                            totalAmount += amount;
                            
                            // Status
                            let status = '<span class="status-badge status-active">COMPLETED</span>';
                            if (payment.status !== 'completed') {
                                status = '<span class="status-badge status-expired">FAILED</span>';
                            }
                            
                            // Date
                            let date = 'N/A';
                            if (payment.timestamp) {
                                date = payment.timestamp.toDate ? 
                                    payment.timestamp.toDate().toLocaleString() : 
                                    new Date(payment.timestamp).toLocaleString();
                            }
                            
                            row.innerHTML = `
                                <td><small>${payment.orderId || 'N/A'}</small></td>
                                <td>${payment.username || 'Unknown'}</td>
                                <td>${payment.phone || 'N/A'}</td>
                                <td><strong>${amount.toLocaleString()} TZS</strong></td>
                                <td>${payment.package || 'N/A'}</td>
                                <td>${status}</td>
                                <td>${date}</td>
                            `;
                            
                            paymentsList.appendChild(row);
                        });

                        // Update totals
                        document.getElementById('totalPaymentsCount').textContent = totalCount;
                        document.getElementById('totalPaymentsAmount').textContent = totalAmount.toLocaleString() + ' TZS';

                        loading.style.display = 'none';
                        table.style.display = 'table';
                    });

            } catch (error) {
                console.error('Error loading payments:', error);
                showMessage('Error loading payments', 'error');
                loading.style.display = 'none';
            }
        }

        // Load Resellers
        async function loadResellers() {
            const loading = document.getElementById('resellersLoading');
            const table = document.getElementById('resellersTable');
            
            loading.style.display = 'flex';
            table.style.display = 'none';

            try {
                if (resellersListener) resellersListener();
                
                resellersListener = db.collection('users')
                    .where('status', '==', 'reseller')
                    .onSnapshot(async snapshot => {
                        const resellersList = document.getElementById('resellersList');
                        resellersList.innerHTML = '';

                        for (const doc of snapshot.docs) {
                            const reseller = doc.data();
                            const row = document.createElement('tr');
                            
                            // Get codes generated by this reseller
                            const codesSnapshot = await db.collection('codes')
                                .where('generatedBy', '==', reseller.resellerCode)
                                .get();
                            
                            const usedCodes = codesSnapshot.size;
                            const maxCodes = reseller.maxCodes || 10;
                            
                            // Status
                            let status = '<span class="status-badge status-active">ACTIVE</span>';
                            if (reseller.expiry && reseller.expiry < Date.now()) {
                                status = '<span class="status-badge status-expired">EXPIRED</span>';
                            }
                            
                            // Expiry date
                            let expiryDate = 'N/A';
                            if (reseller.expiry) {
                                expiryDate = new Date(reseller.expiry).toLocaleDateString();
                            }
                            
                            row.innerHTML = `
                                <td><strong>${reseller.resellerCode}</strong></td>
                                <td>${reseller.username}</td>
                                <td>${maxCodes}</td>
                                <td>${usedCodes}</td>
                                <td>${expiryDate}</td>
                                <td>${status}</td>
                                <td>
                                    <button class="action-btn action-view" onclick="viewResellerCodes('${reseller.resellerCode}')" title="View Codes">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button class="action-btn action-delete" onclick="deleteReseller('${reseller.username}')" title="Delete Reseller">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                            `;
                            
                            resellersList.appendChild(row);
                        }

                        loading.style.display = 'none';
                        table.style.display = 'table';
                    });

            } catch (error) {
                console.error('Error loading resellers:', error);
                showMessage('Error loading resellers', 'error');
                loading.style.display = 'none';
            }
        }

        // Toggle Code Options
        function toggleCodeOptions() {
            const codeType = document.getElementById('codeType').value;
            const duration = document.getElementById('codeDuration').value;
            
            const codeLimitContainer = document.getElementById('codeLimitContainer');
            const customDaysContainer = document.getElementById('customDaysContainer');
            
            // Show/hide code limit for reseller
            if (codeType === 'reseller') {
                codeLimitContainer.style.display = 'block';
            } else {
                codeLimitContainer.style.display = 'none';
            }
            
            // Show/hide custom days
            if (duration === 'custom') {
                customDaysContainer.style.display = 'block';
            } else {
                customDaysContainer.style.display = 'none';
            }
        }

        // Generate Codes
        async function generateCodes() {
            const codeType = document.getElementById('codeType').value;
            const duration = document.getElementById('codeDuration').value;
            const quantity = parseInt(document.getElementById('codeQuantity').value) || 1;
            const deviceLock = document.getElementById('deviceLock').value === 'true';
            const assignUser = document.getElementById('assignUser').value.trim();
            
            let days = 7; // Default week
            
            if (duration === 'week') days = 7;
            else if (duration === 'month') days = 30;
            else if (duration === 'lifetime') days = 36500; // 100 years
            else if (duration === 'custom') {
                days = parseInt(document.getElementById('customDays').value) || 7;
            }
            
            const expiry = Date.now() + (days * 24 * 60 * 60 * 1000);
            const maxCodes = codeType === 'reseller' ? parseInt(document.getElementById('maxCodes').value) || 10 : null;
            
            if (quantity < 1 || quantity > 50) {
                showMessage('Quantity must be between 1 and 50', 'error');
                return;
            }
            
            if (days < 1 || days > 36500) {
                showMessage('Days must be between 1 and 36500', 'error');
                return;
            }
            
            const codesContainer = document.getElementById('generatedCodes');
            const codeResults = document.getElementById('codeResults');
            codeResults.innerHTML = '';
            
            showMessage(`Generating ${quantity} ${codeType} codes...`, 'info');
            
            try {
                for (let i = 0; i < quantity; i++) {
                    // Generate random code in STANY-XXXXXXXX format
                    const code = 'STANY-' + generateRandomString(8);
                    
                    // Code data
                    const codeData = {
                        type: codeType,
                        duration: duration === 'custom' ? `${days} days` : duration,
                        durationDays: days,
                        expiry: expiry,
                        deviceLock: deviceLock,
                        maxCodes: maxCodes,
                        used: false,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        createdBy: 'admin',
                        createdFor: assignUser || null
                    };
                    
                    // If assigned to user, mark it
                    if (assignUser) {
                        codeData.assignedTo = assignUser;
                    }
                    
                    // Save to Firestore
                    await db.collection('codes').doc(code).set(codeData);
                    
                    // Create code card
                    const codeCard = document.createElement('div');
                    codeCard.className = 'code-card';
                    codeCard.innerHTML = `
                        <div class="code-header">
                            <div style="color:var(--neon-blue); font-family:var(--font-cyber);">
                                <i class="fas fa-key"></i> ${codeType.toUpperCase()} CODE
                            </div>
                            <div style="color:var(--text-muted); font-size:0.8rem;">
                                #${i+1}
                            </div>
                        </div>
                        <div class="code-value" onclick="copyCode('${code}')">
                            ${code}
                        </div>
                        <div class="code-details">
                            <div class="detail-item">
                                <span class="detail-label">Type:</span>
                                <span class="detail-value">${codeType}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Duration:</span>
                                <span class="detail-value">${days} days</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Device Lock:</span>
                                <span class="detail-value">${deviceLock ? 'Yes' : 'No'}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Expires:</span>
                                <span class="detail-value">${new Date(expiry).toLocaleDateString()}</span>
                            </div>
                            ${maxCodes ? `
                            <div class="detail-item">
                                <span class="detail-label">Max Codes:</span>
                                <span class="detail-value">${maxCodes}</span>
                            </div>
                            ` : ''}
                            ${assignUser ? `
                            <div class="detail-item">
                                <span class="detail-label">Assigned To:</span>
                                <span class="detail-value">${assignUser}</span>
                            </div>
                            ` : ''}
                        </div>
                    `;
                    
                    codeResults.appendChild(codeCard);
                }
                
                codesContainer.style.display = 'block';
                showMessage(`${quantity} ${codeType} codes generated successfully!`, 'success');
                
                // Refresh codes list
                loadCodes();
                
                // Clear form
                document.getElementById('assignUser').value = '';
                
            } catch (error) {
                console.error('Error generating codes:', error);
                showMessage('Error generating codes: ' + error.message, 'error');
            }
        }

        // Generate Random String
        function generateRandomString(length) {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let result = '';
            for (let i = 0; i < length; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        }

        // Copy Code
        function copyCode(code) {
            navigator.clipboard.writeText(code).then(() => {
                showMessage(`Code copied to clipboard: ${code}`, 'success');
            }).catch(err => {
                console.error('Copy failed:', err);
                showMessage('Failed to copy code', 'error');
            });
        }

        // View User Details
        async function viewUser(username) {
            try {
                const userDoc = await db.collection('users').doc(username).get();
                if (!userDoc.exists) {
                    showMessage('User not found', 'error');
                    return;
                }
                
                const user = userDoc.data();
                let message = `<h3 style="color:var(--neon-blue); margin-bottom:15px;">User Details: ${username}</h3>`;
                message += `<div style="text-align:left; line-height:1.6;">`;
                
                // Basic info
                message += `<p><strong>Status:</strong> <span style="color:var(--neon-green)">${user.status || 'N/A'}</span></p>`;
                message += `<p><strong>Device ID:</strong> ${user.deviceId || 'N/A'}</p>`;
                
                // Package info
                if (user.package) {
                    message += `<p><strong>Package:</strong> ${user.package}</p>`;
                }
                
                // Expiry
                if (user.expiry) {
                    const expiryDate = new Date(user.expiry);
                    const now = new Date();
                    const daysLeft = Math.ceil((expiryDate - now) / (1000 * 60 * 60 * 24));
                    message += `<p><strong>Expires:</strong> ${expiryDate.toLocaleDateString()} (${daysLeft} days left)</p>`;
                }
                
                // Reseller info
                if (user.status === 'reseller') {
                    message += `<p><strong>Reseller Code:</strong> ${user.resellerCode || 'N/A'}</p>`;
                    message += `<p><strong>Max Codes:</strong> ${user.maxCodes || 0}</p>`;
                    message += `<p><strong>Generated Codes:</strong> ${user.generatedCodes || 0}</p>`;
                }
                
                // Predictions
                if (user.predictionsLeft !== undefined) {
                    message += `<p><strong>Predictions Left:</strong> ${user.predictionsLeft}</p>`;
                }
                if (user.usedPredictions !== undefined) {
                    message += `<p><strong>Used Predictions:</strong> ${user.usedPredictions}</p>`;
                }
                
                // Last active
                if (user.lastActive) {
                    const lastActive = user.lastActive.toDate ? 
                        user.lastActive.toDate().toLocaleString() : 
                        new Date(user.lastActive).toLocaleString();
                    message += `<p><strong>Last Active:</strong> ${lastActive}</p>`;
                }
                
                // Joined date
                if (user.joinedAt) {
                    const joinedDate = user.joinedAt.toDate ? 
                        user.joinedAt.toDate().toLocaleDateString() : 
                        new Date(user.joinedAt).toLocaleDateString();
                    message += `<p><strong>Joined:</strong> ${joinedDate}</p>`;
                }
                
                message += `</div>`;
                
                // Add action buttons
                message += `<div style="margin-top:20px; display:flex; gap:10px; justify-content:center;">`;
                message += `<button class="action-btn action-view" onclick="resetUserPredictions('${username}')" style="padding:8px 15px;">Reset Predictions</button>`;
                message += `<button class="action-btn action-delete" onclick="extendUserAccess('${username}')" style="padding:8px 15px;">Extend Access</button>`;
                message += `</div>`;
                
                showMessage(message, 'info');
                
            } catch (error) {
                console.error('Error viewing user:', error);
                showMessage('Error loading user details', 'error');
            }
        }

        // Delete User
        async function deleteUser(username) {
            if (!confirm(`Are you sure you want to delete user "${username}"? This action cannot be undone.`)) {
                return;
            }
            
            try {
                await db.collection('users').doc(username).delete();
                showMessage(`User "${username}" deleted successfully`, 'success');
            } catch (error) {
                console.error('Error deleting user:', error);
                showMessage('Error deleting user', 'error');
            }
        }

        // Delete Code
        async function deleteCode(code) {
            if (!confirm(`Are you sure you want to delete code "${code}"? This action cannot be undone.`)) {
                return;
            }
            
            try {
                await db.collection('codes').doc(code).delete();
                showMessage(`Code "${code}" deleted successfully`, 'success');
            } catch (error) {
                console.error('Error deleting code:', error);
                showMessage('Error deleting code', 'error');
            }
        }

        // View Reseller Codes
        async function viewResellerCodes(resellerCode) {
            try {
                const codesSnapshot = await db.collection('codes')
                    .where('generatedBy', '==', resellerCode)
                    .get();
                
                let message = `<h3 style="color:var(--neon-blue); margin-bottom:10px;">Codes Generated by ${resellerCode}</h3>`;
                message += `<div style="max-height:300px; overflow-y:auto; margin-top:10px;">`;
                
                if (codesSnapshot.empty) {
                    message += '<p>No codes generated yet.</p>';
                } else {
                    message += '<table style="width:100%; border-collapse:collapse; font-size:0.9rem;">';
                    message += '<tr style="background:rgba(0,0,0,0.2);">';
                    message += '<th style="padding:8px; border-bottom:1px solid var(--glass-border);">Code</th>';
                    message += '<th style="padding:8px; border-bottom:1px solid var(--glass-border);">Status</th>';
                    message += '<th style="padding:8px; border-bottom:1px solid var(--glass-border);">Used By</th>';
                    message += '<th style="padding:8px; border-bottom:1px solid var(--glass-border);">Created</th>';
                    message += '</tr>';
                    
                    codesSnapshot.forEach(doc => {
                        const code = doc.data();
                        let createdDate = 'N/A';
                        if (code.createdAt) {
                            createdDate = code.createdAt.toDate ? 
                                code.createdAt.toDate().toLocaleDateString() : 
                                new Date(code.createdAt).toLocaleDateString();
                        }
                        
                        message += `<tr>
                            <td style="padding:8px; border-bottom:1px solid var(--glass-border);">${doc.id}</td>
                            <td style="padding:8px; border-bottom:1px solid var(--glass-border);">
                                <span style="color:${code.used ? 'var(--neon-red)' : 'var(--neon-green)'}">
                                    ${code.used ? 'Used' : 'Active'}
                                </span>
                            </td>
                            <td style="padding:8px; border-bottom:1px solid var(--glass-border);">${code.usedBy || 'Not used'}</td>
                            <td style="padding:8px; border-bottom:1px solid var(--glass-border);">${createdDate}</td>
                        </tr>`;
                    });
                    
                    message += '</table>';
                }
                
                message += '</div>';
                showMessage(message, 'info');
                
            } catch (error) {
                console.error('Error viewing reseller codes:', error);
                showMessage('Error loading reseller codes', 'error');
            }
        }

        // Delete Reseller
        async function deleteReseller(username) {
            if (!confirm(`Are you sure you want to delete reseller "${username}"? This will also delete all their generated codes.`)) {
                return;
            }
            
            try {
                // Get reseller data first
                const resellerDoc = await db.collection('users').doc(username).get();
                if (!resellerDoc.exists) {
                    showMessage('Reseller not found', 'error');
                    return;
                }
                
                const reseller = resellerDoc.data();
                
                // Delete all codes generated by this reseller
                const codesSnapshot = await db.collection('codes')
                    .where('generatedBy', '==', reseller.resellerCode)
                    .get();
                
                const batch = db.batch();
                codesSnapshot.forEach(doc => {
                    batch.delete(doc.ref);
                });
                
                // Delete reseller user
                batch.delete(db.collection('users').doc(username));
                
                await batch.commit();
                showMessage(`Reseller "${username}" and all their codes deleted successfully`, 'success');
                
            } catch (error) {
                console.error('Error deleting reseller:', error);
                showMessage('Error deleting reseller', 'error');
            }
        }

        // Load Settings
        async function loadSettings() {
            try {
                const settingsDoc = await db.collection('settings').doc('system').get();
                if (settingsDoc.exists) {
                    const settings = settingsDoc.data();
                    
                    document.getElementById('freeTrialsPerDay').value = settings.freeTrialsPerDay || 2;
                    document.getElementById('freeTrialHours').value = settings.freeTrialHours || 2;
                    document.getElementById('weeklyPrice').value = settings.weeklyPrice || 3000;
                    document.getElementById('monthlyPrice').value = settings.monthlyPrice || 4000;
                    document.getElementById('lifetimePrice').value = settings.lifetimePrice || 5000;
                    document.getElementById('harakapayApiKey').value = settings.harakapayApiKey || HARAKA_API_KEY;
                    document.getElementById('whatsappNumber').value = settings.whatsappNumber || '255XXXXXXXXX';
                }
            } catch (error) {
                console.error('Error loading settings:', error);
            }
        }

        // Save Settings
        async function saveSettings() {
            try {
                const settings = {
                    freeTrialsPerDay: parseInt(document.getElementById('freeTrialsPerDay').value) || 2,
                    freeTrialHours: parseInt(document.getElementById('freeTrialHours').value) || 2,
                    weeklyPrice: parseInt(document.getElementById('weeklyPrice').value) || 3000,
                    monthlyPrice: parseInt(document.getElementById('monthlyPrice').value) || 4000,
                    lifetimePrice: parseInt(document.getElementById('lifetimePrice').value) || 5000,
                    harakapayApiKey: document.getElementById('harakapayApiKey').value.trim(),
                    whatsappNumber: document.getElementById('whatsappNumber').value.trim(),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                await db.collection('settings').doc('system').set(settings, { merge: true });
                showMessage('Settings saved successfully!', 'success');
                
            } catch (error) {
                console.error('Error saving settings:', error);
                showMessage('Error saving settings', 'error');
            }
        }

        // Clear Expired Data
        async function clearExpiredData() {
            if (!confirm('Are you sure you want to clear all expired data? This action cannot be undone.')) {
                return;
            }
            
            showMessage('Clearing expired data...', 'info');
            
            try {
                const now = Date.now();
                const batch = db.batch();
                let count = 0;
                
                // Clear expired users
                const usersSnapshot = await db.collection('users').get();
                usersSnapshot.forEach(doc => {
                    const user = doc.data();
                    if (user.expiry && user.expiry < now && user.status !== 'reseller') {
                        batch.delete(doc.ref);
                        count++;
                    }
                });
                
                // Clear expired codes
                const codesSnapshot = await db.collection('codes').get();
                codesSnapshot.forEach(doc => {
                    const code = doc.data();
                    if (code.expiry && code.expiry < now) {
                        batch.delete(doc.ref);
                        count++;
                    }
                });
                
                await batch.commit();
                showMessage(`Cleared ${count} expired records successfully!`, 'success');
                
                // Refresh data
                loadUsers();
                loadCodes();
                loadStats();
                
            } catch (error) {
                console.error('Error clearing expired data:', error);
                showMessage('Error clearing expired data', 'error');
            }
        }

        // Export Data
        async function exportData() {
            showMessage('Preparing data export...', 'info');
            
            try {
                // Get all data
                const [usersSnapshot, codesSnapshot, paymentsSnapshot] = await Promise.all([
                    db.collection('users').get(),
                    db.collection('codes').get(),
                    db.collection('payments').get()
                ]);
                
                // Convert to CSV
                let csv = 'Data Type,Username/Code,Status,Expiry,Created\n';
                
                // Users
                usersSnapshot.forEach(doc => {
                    const user = doc.data();
                    const expiry = user.expiry ? new Date(user.expiry).toLocaleDateString() : 'N/A';
                    const created = user.joinedAt ? new Date(user.joinedAt).toLocaleDateString() : 'N/A';
                    csv += `USER,${doc.id},${user.status},${expiry},${created}\n`;
                });
                
                // Codes
                codesSnapshot.forEach(doc => {
                    const code = doc.data();
                    const expiry = code.expiry ? new Date(code.expiry).toLocaleDateString() : 'N/A';
                    const created = code.createdAt ? new Date(code.createdAt).toLocaleDateString() : 'N/A';
                    csv += `CODE,${doc.id},${code.used ? 'USED' : 'ACTIVE'},${expiry},${created}\n`;
                });
                
                // Payments
                paymentsSnapshot.forEach(doc => {
                    const payment = doc.data();
                    const date = payment.timestamp ? new Date(payment.timestamp).toLocaleDateString() : 'N/A';
                    csv += `PAYMENT,${payment.orderId},${payment.status},${payment.amount} TZS,${date}\n`;
                });
                
                // Create download link
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `stany-mines-data-${new Date().toISOString().split('T')[0]}.csv`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
                
                showMessage('Data exported successfully!', 'success');
                
            } catch (error) {
                console.error('Error exporting data:', error);
                showMessage('Error exporting data', 'error');
            }
        }

        // Refresh Resellers
        function refreshResellers() {
            loadResellers();
            showMessage('Resellers list refreshed', 'info');
        }

        // Reset User Predictions
        async function resetUserPredictions(username) {
            try {
                await db.collection('users').doc(username).update({
                    usedPredictions: 0,
                    lastActive: firebase.firestore.FieldValue.serverTimestamp()
                });
                showMessage(`Predictions reset for ${username}`, 'success');
            } catch (error) {
                console.error('Error resetting predictions:', error);
                showMessage('Error resetting predictions', 'error');
            }
        }

        // Extend User Access
        async function extendUserAccess(username) {
            const days = prompt('Enter number of days to extend:', '30');
            if (!days || isNaN(days) || days < 1) return;
            
            try {
                const userDoc = await db.collection('users').doc(username).get();
                if (!userDoc.exists) {
                    showMessage('User not found', 'error');
                    return;
                }
                
                const user = userDoc.data();
                const currentExpiry = user.expiry || Date.now();
                const newExpiry = new Date(currentExpiry).getTime() + (parseInt(days) * 24 * 60 * 60 * 1000);
                
                await db.collection('users').doc(username).update({
                    expiry: newExpiry,
                    lastActive: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                showMessage(`Access extended by ${days} days for ${username}`, 'success');
                
            } catch (error) {
                console.error('Error extending access:', error);
                showMessage('Error extending access', 'error');
            }
        }

        // Utility Functions
        function getTimeAgo(date) {
            const seconds = Math.floor((new Date() - date) / 1000);
            
            if (seconds < 60) return 'Just now';
            
            const minutes = Math.floor(seconds / 60);
            if (minutes < 60) return `${minutes}m ago`;
            
            const hours = Math.floor(minutes / 60);
            if (hours < 24) return `${hours}h ago`;
            
            const days = Math.floor(hours / 24);
            if (days < 7) return `${days}d ago`;
            
            return date.toLocaleDateString();
        }

        // Message Functions
        function showMessage(message, type = 'info') {
            const messageBox = document.getElementById('messageBox');
            const messageContent = document.getElementById('messageContent');
            
            let color = 'var(--neon-blue)';
            if (type === 'error') color = 'var(--neon-red)';
            else if (type === 'success') color = 'var(--neon-green)';
            else if (type === 'warning') color = 'var(--neon-yellow)';
            
            messageContent.innerHTML = `<div style="color:${color};">${message}</div>`;
            messageBox.classList.add('show');
            
            setTimeout(hideMessage, 5000);
        }

        function hideMessage() {
            document.getElementById('messageBox').classList.remove('show');
        }
    </script>
</body>
</html>
